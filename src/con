#!/bin/bash

# For Windows, we need to change '\' to '/'.
export GIT_CONVEY_DIR=$(dirname "$(echo "$0" | sed -e 's|\\|/|g')")

source "$HOME/.conveyor/config"
source "$GIT_CONVEY_DIR/lib/resty"
source "$GIT_CONVEY_DIR/lib/rest-lib.sh"
source "$GIT_CONVEY_DIR/common-checks.sh"
source "$GIT_CONVEY_DIR/common-lib.sh"

# Normally, we'd use 'shflags' here, but we can't seem to do patial flag
# progessing... even though something like it has been emprically working for
# awhile.

# Handle the 'set resource' case.
if [ x"$1" == x"-s" ] || [ x"$1" == x"--setresource" ]; then
    shift
    if [ $# -eq 0 ]; then # clear implied resource, if it exists.
	if [ -f $HOME/.conveyor-workflow/implied-resource ]; then
	    rm -f $HOME/.conveyor-workflow/implied-resource
	    echo "Implied resource cleared."
	fi
    elif [ $# -eq 1 ]; then # set implied resource.
	case "$1" in
	    topics|releases|issues|repos)
		echo "$1" > $HOME/.conveyor-workflow/implied-resource
		echo "Resource set as '$1'.";;
	    *)
		echo "ERROR: Unknown resource '$1'." >&2
		exit 1;;
	esac
    else
	echo "You may only supply a single supplied resource: topics, releases,  issues, or repos." >&2
	exit 1
    fi
    exit 0 # If we successfully set resource, then we're done.
    # 'set-resources' handling
elif [ x"$1" == x"--verify" ] || [ x"$1" == x"--verifyresource" ] || [ x"$1" == x"--verifyglobal" ]; then
    OPTION="$1"; shift
    case "$1" in
	'')
	    echo "ERROR: '--verify(*)' requires value." >&2
	    exit 1;;
	topics|releases|issues|repos|status)
	    if [ "$OPTION" == "--verify" ] || [ "$OPTION" == "--verifyresource" ]; then
		echo "Resource '$1' is valid."
		exit 0
	    else
		echo "'$1' is not a valid global action."
		exit 1
	    fi;;
	status|sync|launch-web-dashboard)
	    if [ "$OPTION" == "--verify" ] || [ "$OPTION" == "--verifyglobal" ]; then
		echo "Global action '$1' is valid."
		exit 0
	    else
		echo "'$1' is not a valid resource."
		exit 1
	    fi;;
	*)
	    echo "Resource '$1' is invalid."
	    exit 1;;
    esac
fi
# ... else it's a <resource> [<action>] style command.

#/**
#  * <div class="subHeader"><span>Options Parsing</span></div>
#  */
source "$HOME/.conveyor/config"
CON_HOME=`which con`
CON_HOME=`dirname "$CON_HOME"`
source "$CON_HOME/lib/help.sh"

if [ $# -lt 1 ]; then
    usage "Please indicate resource."
    exit 1
fi

FOUND_SOMETHING=0
while [ $# -gt 0 ] && [ $FOUND_SOMETHING -eq 0 ]; do
    FOUND_SOMETHING=1
    if [ "$1" == '--verbose' ] || [ "$1" == '-v' ]; then
	FOUND_SOMETHING=0
	shift
    elif [ "$1" == '--test' ]; then
	FOUND_SOMETHING=0
	shift
	export GIT_CONVEY_TEST_MODE=0 # bash true
    fi
done

#/**
#* <div class="subHeader"><span>Main Logic</span></div>
#* <div class="p">
#*   Normally, we would process the arguments into named variables as a first
#*   step. In this case, the processing differences between 'implied
#*   resources' and 'explicit resources' means we have to do some work to
#*   establish the semantics of teh arguments.
#* </div>
#*/
if [ x"$1" == x"help" ]; then
    shift
    if [ $# -eq 0 ]; then
	usage
    else
	RESOURCE="$1"; shift
	source "$CON_HOME/git-conveyor-$RESOURCE"
	if [ $# -eq 0 ]; then
	    resource_usage
	else
	    ACTION="$1"; shift
	    resource_help $ACTION
	fi
    fi
    exit 0
fi

if [ -f $HOME/.conveyor-workflow/implied-resource ]; then
    RESOURCE=`cat $HOME/.conveyor-workflow/implied-resource`
    source "$CON_HOME/git-conveyor-$RESOURCE"
    if [ x`type -t action_check` != x'function' ]; then
	echo "WARNING: 'action_check' function not defined for '$RESOURCE'." >&2
	# Nothing else to do.
    else
	if ! action_check "$1" && ! con --verify "$1" >/dev/null; then
	    usage "ERROR: Cannot understand '$1' as action, resource, or global."
	    exit 1
	elif con --verifyresource "$1" >/dev/null; then
	    RESOURCE="$1"; shift
	    echo "RESOURCE: $RESOURCE"
	    if [ "$RESOURCE" != "status" ]; then
		rm -f $HOME/.conveyor-workflow/implied-resource
		echo "WARNING: understood '$RESOURCE' as resource; implied resource reset." >&2
	    fi
	elif con --verifyglobal "$1" >/dev/null; then
	    RESOURCE="$1"; shift # and nothing else
	# else, it's an action of the implied resource, which is just fine
	fi
    fi
else
    RESOURCE="$1"; shift
fi

function launch_web_dashboard() {
    if [ x"$CONVEYOR_DEFAULT_BROWSER_BIN" == x"" ]; then
	CONVEYOR_DEFAULT_BROWSER_BIN=chromium
    fi
    $CONVEYOR_DEFAULT_BROWSER_BIN 127.0.0.1:42069 2> chromium-log &
}

case "$RESOURCE" in
    launch-web-dashboard) # global action
	launch_web_dashboard
	;;
    topics|releases|sync|status)
	git conveyor "$RESOURCE" "$@"
	;;
    *)
	if [ -f "$CON_HOME/conveyor-$RESOURCE" ]; then
	    source "$CON_HOME/conveyor-$RESOURCE"
	    process "$@"
	else
	    echo "ERROR: Unknown resource '$RESOURCE'." >&2
	    exit 1
	fi
	;;
esac
