resource_usage() {
    if [ x"$1" != x"" ]; then
	echo $1 >&2
	echo >&2
    fi

    echo "usage: con init <source repo name> [<staging dir>]"
    echo
    echo "Used to initialize a new origin repository for git-convey. This is a"
    echo "standard git repository with the 'master' branch pre-populated with"
    echo "a README.repo file."
    echo
    echo "Use 'con sync' to checkout a local working directory."
}

resource_do() {
    if [ $# -lt 1 ] || [ $# -gt 2 ]; then
	resource_usage "Unknown usage for 'con init'."
	exit 1
    fi

    local REPO_NAME="$1"; shift
    local STAGING_DIR
    if [ $# -ge 1 ]; then
	STAGING_DIR="$1"; shift
    else
	STAGING_DIR="staging"
    fi

    generic_name_tests "$REPO_NAME"

    # Create the repo.
    mkdir ${REPO_NAME}.git
    cd ${REPO_NAME}.git
    git init --bare --quiet .

    # Create clone into staging and initialize for git-convey.
    cd ..
    git clone --quiet file://$PWD/${REPO_NAME}.git "$STAGING_DIR" 2>/dev/null
    cd "$STAGING_DIR"
    cat <<EOF > README.repo
This is a git-convey repository and is intended for use with git-convey
porcelain. For further information, please refer to:

http://dogfoodsoftware.com/documentation/git-convey
EOF
    git add README.repo
    git commit --quiet -m "Initialized git-convey repo with README.repo file."
    # For some reason, the 'push' output comes out ot stderr...
    git push --quiet origin master
    cd ..
    rm -rf "$STAGING_DIR"

    # TODO: use 'shell-echo.sh' functions for quite output.
    echo "'$REPO_NAME' initialized."
}
